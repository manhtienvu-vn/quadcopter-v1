/*
 * PID.c
 *
 *  Created on: Jan 24, 2026
 *      Author: ADMIN
 */


#include "PID.h"


float PID_Init(PID *pid){

	/*Clear controller variables*/
	pid->Kp = 0.0f;
	pid->Ki = 0.0f;
	pid->Kd = 0.0f;

	pid->error = 0.0f;
	pid->prev_error = 0.0f;

	pid->integration = 0.0f;
	pid->integral_limit = 0.0f;

	pid->differentiation = 0.0f;
	pid->measurement = 0.0f;

	pid->output = 0.0f;
	pid->output_limit = 0.0f;
}

void PID_SetParameters(PID *pid, float kp, float ki, float kd, float setpoint, float measurement){
	pid->Kp = kp;
	pid->Ki = ki;
	pid->Kd = kd;
	pid->setpoint = setpoint;
	pid->measurement = measurement;
}
float PID_Compute(PID *pid){

	pid->error = pid->measurement - pid->setpoint;

	pid->propotional = pid->error;

	/*Use 'Trapezoidal Rule' or 'Tustin Method' to calculate the cumulative errors */
	pid->integration += 0.5f * (pid->error + pid->prev_error) * pid->dt;

	pid->differentiation = (pid->measurement - pid->prev_measurement) / pid->dt;

	pid->output = pid->propotional * pid->Kp + pid->integration * pid->Ki + pid->differentiation * pid->Kd;

	/*NOTICE 1: Integration anti-windup*/
	if(pid->integral_limit >= pid->integral_limit){
		pid->integral_limit = pid->integral_limit;
	}

	/*NOTICE 2: Clamp controller output*/
	if (pid->output > pid->output_limit){
		pid->output = pid->output_limit;
	}

	/*Update previous error as current error for future computation*/
	pid->prev_measurement = pid->measurement;
	pid->prev_error = pid->error;

	return pid->output;
}

